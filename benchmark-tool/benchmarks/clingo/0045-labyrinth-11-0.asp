field(1,1).
field(1,2).
field(1,3).
field(1,4).
field(1,5).
field(1,6).
field(1,7).
field(1,8).
field(1,9).
field(1,10).
field(2,1).
field(2,2).
field(2,3).
field(2,4).
field(2,5).
field(2,6).
field(2,7).
field(2,8).
field(2,9).
field(2,10).
field(3,1).
field(3,2).
field(3,3).
field(3,4).
field(3,5).
field(3,6).
field(3,7).
field(3,8).
field(3,9).
field(3,10).
field(4,1).
field(4,2).
field(4,3).
field(4,4).
field(4,5).
field(4,6).
field(4,7).
field(4,8).
field(4,9).
field(4,10).
field(5,1).
field(5,2).
field(5,3).
field(5,4).
field(5,5).
field(5,6).
field(5,7).
field(5,8).
field(5,9).
field(5,10).
field(6,1).
field(6,2).
field(6,3).
field(6,4).
field(6,5).
field(6,6).
field(6,7).
field(6,8).
field(6,9).
field(6,10).
field(7,1).
field(7,2).
field(7,3).
field(7,4).
field(7,5).
field(7,6).
field(7,7).
field(7,8).
field(7,9).
field(7,10).
field(8,1).
field(8,2).
field(8,3).
field(8,4).
field(8,5).
field(8,6).
field(8,7).
field(8,8).
field(8,9).
field(8,10).
field(9,1).
field(9,2).
field(9,3).
field(9,4).
field(9,5).
field(9,6).
field(9,7).
field(9,8).
field(9,9).
field(9,10).
field(10,1).
field(10,2).
field(10,3).
field(10,4).
field(10,5).
field(10,6).
field(10,7).
field(10,8).
field(10,9).
field(10,10).
init_on(2,9).
goal_on(2,2).
connect(1,1,n).
connect(1,2,n).
connect(1,4,n).
connect(1,5,n).
connect(1,9,n).
connect(1,10,n).
connect(2,2,n).
connect(2,6,n).
connect(2,10,n).
connect(3,2,n).
connect(3,4,n).
connect(3,5,n).
connect(3,8,n).
connect(4,1,n).
connect(4,3,n).
connect(4,5,n).
connect(4,7,n).
connect(4,10,n).
connect(5,1,n).
connect(5,2,n).
connect(5,3,n).
connect(5,9,n).
connect(5,10,n).
connect(6,1,n).
connect(6,2,n).
connect(6,3,n).
connect(6,4,n).
connect(6,6,n).
connect(6,8,n).
connect(7,5,n).
connect(7,7,n).
connect(7,9,n).
connect(7,10,n).
connect(8,4,n).
connect(8,7,n).
connect(8,9,n).
connect(8,10,n).
connect(9,2,n).
connect(9,3,n).
connect(9,9,n).
connect(10,3,n).
connect(10,5,n).
connect(10,6,n).
connect(10,7,n).
connect(10,8,n).
connect(1,1,w).
connect(1,3,w).
connect(2,1,w).
connect(2,4,w).
connect(2,5,w).
connect(2,7,w).
connect(2,9,w).
connect(3,4,w).
connect(3,6,w).
connect(3,9,w).
connect(3,10,w).
connect(4,2,w).
connect(4,3,w).
connect(4,6,w).
connect(4,7,w).
connect(4,9,w).
connect(4,10,w).
connect(5,3,w).
connect(5,4,w).
connect(5,5,w).
connect(5,6,w).
connect(5,8,w).
connect(6,5,w).
connect(7,3,w).
connect(7,4,w).
connect(7,5,w).
connect(7,6,w).
connect(7,7,w).
connect(8,3,w).
connect(8,4,w).
connect(8,8,w).
connect(8,9,w).
connect(9,4,w).
connect(9,5,w).
connect(9,7,w).
connect(9,8,w).
connect(10,1,w).
connect(10,2,w).
connect(10,3,w).
connect(10,5,w).
connect(10,6,w).
connect(10,7,w).
connect(10,8,w).
connect(1,4,e).
connect(1,5,e).
connect(1,6,e).
connect(1,8,e).
connect(2,3,e).
connect(2,6,e).
connect(2,7,e).
connect(2,8,e).
connect(3,2,e).
connect(3,4,e).
connect(3,7,e).
connect(3,8,e).
connect(4,1,e).
connect(4,4,e).
connect(5,3,e).
connect(5,4,e).
connect(6,1,e).
connect(6,2,e).
connect(6,8,e).
connect(6,9,e).
connect(6,10,e).
connect(7,5,e).
connect(7,6,e).
connect(7,7,e).
connect(7,9,e).
connect(7,10,e).
connect(8,1,e).
connect(8,2,e).
connect(8,6,e).
connect(8,9,e).
connect(8,10,e).
connect(9,6,e).
connect(9,8,e).
connect(10,5,e).
connect(10,6,e).
connect(10,7,e).
connect(10,10,e).
connect(1,2,s).
connect(1,3,s).
connect(1,4,s).
connect(1,5,s).
connect(1,7,s).
connect(1,9,s).
connect(2,6,s).
connect(3,1,s).
connect(3,3,s).
connect(3,4,s).
connect(4,3,s).
connect(4,6,s).
connect(4,8,s).
connect(5,3,s).
connect(5,4,s).
connect(5,7,s).
connect(6,2,s).
connect(6,3,s).
connect(6,7,s).
connect(6,8,s).
connect(6,10,s).
connect(7,1,s).
connect(7,2,s).
connect(7,5,s).
connect(7,6,s).
connect(7,7,s).
connect(7,8,s).
connect(7,9,s).
connect(8,4,s).
connect(8,5,s).
connect(8,9,s).
connect(9,1,s).
connect(9,3,s).
connect(9,8,s).
connect(9,9,s).
connect(9,10,s).
connect(10,1,s).
connect(10,2,s).
connect(10,4,s).
connect(10,5,s).
connect(10,6,s).
connect(10,7,s).
connect(10,8,s).
connect(10,9,s).
max_steps(10).
#include <incmode>.
#program base.
dir(e). dir(w). dir(n). dir(s).
inverse(e,w). inverse(w,e).
inverse(n,s). inverse(s,n).

row(X) :- field(X,Y).
col(Y) :- field(X,Y).

num_rows(X) :- row(X), not row(XX), XX = X+1.
num_cols(Y) :- col(Y), not col(YY), YY = Y+1.

goal(X,Y,0)   :- goal_on(X,Y).
reach(X,Y,0)  :- init_on(X,Y).
conn(X,Y,D,0) :- connect(X,Y,D).

dneighbor(n,X,Y,XX,Y) :- field(X,Y), field(XX,Y), XX = X+1.
dneighbor(s,X,Y,XX,Y) :- field(X,Y), field(XX,Y), XX = X-1.
dneighbor(e,X,Y,X,YY) :- field(X,Y), field(X,YY), YY = Y+1.
dneighbor(w,X,Y,X,YY) :- field(X,Y), field(X,YY), YY = Y-1.

neighbor(D,X,Y,XX,YY) :- dneighbor(D,X,Y,XX,YY).
neighbor(n,X,Y, 1, Y) :- field(X,Y), num_rows(X).
neighbor(s,1,Y, X, Y) :- field(X,Y), num_rows(X).
neighbor(e,X,Y, X, 1) :- field(X,Y), num_cols(Y).
neighbor(w,X,1, X, Y) :- field(X,Y), num_cols(Y).

#program check(t).
neg_goal(t) :- goal(X,Y,t), not reach(X,Y,t).

#program step(t).
{ occurs(some_action,t) }.
rrpush(t)   :- neg_goal(t-1), not ccpush(t), occurs(some_action,t).
ccpush(t)   :- neg_goal(t-1), not rrpush(t), occurs(some_action,t).

orpush(X,t) :- row(X), row(XX), rpush(XX,t), X != XX.
ocpush(Y,t) :- col(Y), col(YY), cpush(YY,t), Y != YY.

rpush(X,t)  :- row(X), rrpush(t), not orpush(X,t).
cpush(Y,t)  :- col(Y), ccpush(t), not ocpush(Y,t).

push(X,e,t) :- rpush(X,t), not push(X,w,t).
push(X,w,t) :- rpush(X,t), not push(X,e,t).
push(Y,n,t) :- cpush(Y,t), not push(Y,s,t).
push(Y,s,t) :- cpush(Y,t), not push(Y,n,t).

shift(XX,YY,X,Y,t) :- neighbor(e,XX,YY,X,Y), push(XX,e,t).
shift(XX,YY,X,Y,t) :- neighbor(w,XX,YY,X,Y), push(XX,w,t).
shift(XX,YY,X,Y,t) :- neighbor(n,XX,YY,X,Y), push(YY,n,t).
shift(XX,YY,X,Y,t) :- neighbor(s,XX,YY,X,Y), push(YY,s,t).
shift( X, Y,X,Y,t) :- field(X,Y), not push(X,e,t), not push(X,w,t), not push(Y,n,t), not push(Y,s,t).

conn(X,Y,D,t) :- conn(XX,YY,D,t-1), dir(D), shift(XX,YY,X,Y,t).

goal(X,Y,t) :- goal(XX,YY,t-1), shift(XX,YY,X,Y,t).

reach(X,Y,t) :- reach(XX,YY,t-1), shift(XX,YY,X,Y,t).
reach(X,Y,t) :- reach(XX,YY,t), dneighbor(D,XX,YY,X,Y), conn(XX,YY,D,t), conn(X,Y,E,t), inverse(D,E).

#program check(t).
:- neg_goal(t), query(t).
